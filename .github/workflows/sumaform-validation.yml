name: Sumaform validation

on:
  pull_request:
    paths:
      - 'terracumber_config/tf_files/**/*.tf'
      - '!terracumber_config/tf_files/*build-validation*.tf'
      - '!terracumber_config/tf_files/templates/PR-testing-template.tf'

jobs:
  validate_sumaform:
    name: Validate sumaform files
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - id: tf_files
        name: Get modified .tf files
        uses: Ana06/get-changed-files@v2.3.0
        with:
          filter: '*.tf'

      - name: Install terraform
        if: steps.tf_files.outputs.added_modified
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
          terraform_wrapper: false

      - name: Install opentofu
        if: steps.tf_files.outputs.added_modified
        uses: opentofu/setup-opentofu@v1.0.6
        with:
          tofu_version: 1.10.7

      - name: Checkout sumaform
        if: steps.tf_files.outputs.added_modified
        uses: actions/checkout@v4
        with:
          repository: uyuni-project/sumaform
          path: sumaform

      # --- CHANGED: Build provider from source instead of downloading assets ---
      - name: Build Feilong terraform provider
        if: steps.tf_files.outputs.added_modified
        run: |
          echo "::group::Build Feilong Provider"
          # Clone the specific version tag
          git clone --depth 1 --branch v0.0.6 https://github.com/Bischoff/terraform-provider-feilong.git build_feilong
          cd build_feilong
          
          # Build the binary
          go build -o terraform-provider-feilong
          
          # Prepare the local plugin directory structure
          # Registry: registry.terraform.io / Namespace: bischoff / Type: feilong
          PLUGIN_DIR="$HOME/.terraform.d/plugins/registry.terraform.io/bischoff/feilong/0.0.6/linux_amd64"
          mkdir -p "$PLUGIN_DIR"
          
          # Move and set permissions
          mv terraform-provider-feilong "$PLUGIN_DIR/"
          chmod +x "$PLUGIN_DIR/terraform-provider-feilong"
          
          echo "Provider installed to $PLUGIN_DIR"
          ls -l "$PLUGIN_DIR"
          echo "::endgroup::"
      # -----------------------------------------------------------------------

      - name: Terraform validation
        if: steps.tf_files.outputs.added_modified
        run: |
          # --- Legacy Terraform Validation Loop ---
          for tf_file in ${{steps.tf_files.outputs.added_modified}}; do
            if [[ "$tf_file" == *"build-validation"* ]]; then
              echo "::notice::[TERRAFORM] Validating legacy build-validation file '`basename $tf_file`'..."
              rm -f main.tf variables.tf environment.tfvars
              cp $tf_file main.tf
              SOURCE_DIR=$(dirname "$tf_file")
              PLAN_ARGS=""
              if [ -f "$SOURCE_DIR/variables.tf" ]; then
                cp "$SOURCE_DIR/variables.tf" variables.tf
                echo "::notice::Included variables.tf from $SOURCE_DIR"
              fi
              if [ -f "$SOURCE_DIR/environment.tfvars" ]; then
                cp "$SOURCE_DIR/environment.tfvars" environment.tfvars
                PLAN_ARGS="-var-file=environment.tfvars"
                echo "::notice::Included environment.tfvars from $SOURCE_DIR"
              fi
              terraform init -input=false
              terraform validate
              terraform plan -input=false $PLAN_ARGS
              echo
            fi
          done
          
          # --- OpenTofu Validation Loop ---
          for tf_file in ${{steps.tf_files.outputs.added_modified}}; do
            if [[ "$tf_file" != "terracumber_config/tf_files/templates/PR-testing-template.tf" ]]; then
              echo "::notice::[TOFU] Validating '`basename $tf_file`'..."
              rm -f main.tf variables.tf environment.tfvars location.tfvars sample.tfvars
              cp ../$tf_file main.tf
              SOURCE_DIR=$(dirname "../$tf_file")
              PLAN_ARGS=""

              # 1. Handle Variables
              if [ -f "$SOURCE_DIR/variables.tf" ]; then
                cp "$SOURCE_DIR/variables.tf" variables.tf
                echo "::notice::Included variables.tf from $SOURCE_DIR"
              elif [ -f "$SOURCE_DIR/../variables/build-validation-variables.tf" ]; then
                cp "$SOURCE_DIR/../variables/build-validation-variables.tf" variables.tf
                echo "::notice::Included build-validation-variables.tf from $SOURCE_DIR/../variables/"
              fi

              # 2. Handle TFVars (Inputs)
              if [ -f "$SOURCE_DIR/environment.tfvars" ]; then
                cp "$SOURCE_DIR/environment.tfvars" environment.tfvars
                PLAN_ARGS="-var-file=environment.tfvars"
                echo "::notice::Included environment.tfvars from $SOURCE_DIR"
              elif [[ "$tf_file" == *"template-build-validation.tf" ]]; then
                 if [ -f "$SOURCE_DIR/../tfvars/location.tfvars" ]; then
                    cp "$SOURCE_DIR/../tfvars/location.tfvars" location.tfvars
          
                    # Search recursively for a sample .tfvars file
                    SAMPLE_VAR_PATH=$(find "$SOURCE_DIR/../tfvars" -name "*nue.tfvars" | head -n 1)
                    if [ -n "$SAMPLE_VAR_PATH" ]; then
                       cp "$SAMPLE_VAR_PATH" sample.tfvars
                       PLAN_ARGS="-var-file=location.tfvars -var-file=sample.tfvars"
                       echo "::notice::Included location.tfvars and sample $(basename $SAMPLE_VAR_PATH)"
                    else
                       echo "::warning::Could not find a sample .tfvars file for validation"
                    fi
                 fi
              fi

              tofu init -input=false
              tofu validate
              tofu plan -input=false $PLAN_ARGS
              echo
            fi
          done
        working-directory: sumaform