#!/usr/bin/env groovy

node('sumaform-cucumber') {
    def minionList = 'sles12sp5_minion, sles12sp5_sshminion, ' +
            'sles15sp2_minion, sles15sp2_sshminion, ' +
            'sles15sp3_minion, sles15sp3_sshminion, ' +
            'sles15sp4_minion, sles15sp4_sshminion, ' +
            'sles15sp5_minion, sles15sp5_sshminion, ' +
            'sles15sp6_minion, sles15sp6_sshminion, ' +
            'salt_migration_minion, ' +
            'alma8_minion, alma8_sshminion, alma9_minion, alma9_sshminion, ' +
            'centos7_minion, centos7_sshminion, ' +
            'liberty9_minion, liberty9_sshminion, ' +
            'oracle9_minion, oracle9_sshminion, ' +
            'rocky8_minion, rocky8_sshminion, rocky9_minion, rocky9_sshminion, ' +
            'ubuntu2004_minion, ubuntu2004_sshminion, ubuntu2204_minion, ubuntu2204_sshminion, ubuntu2404_minion, ubuntu2404_sshminion, ' +
            'debian11_minion, debian11_sshminion, debian12_minion, debian12_sshminion, ' +
            'opensuse155arm_minion, opensuse155arm_sshminion, ' +
            'opensuse156arm_minion, opensuse156arm_sshminion, ' +
            'sles15sp5s390_minion, sles15sp5s390_sshminion, ' +
            'slemicro51_minion, slemicro52_minion, slemicro53_minion, slemicro54_minion, slemicro55_minion, slmicro60_minion'
    properties([
        buildDiscarder(logRotator(numToKeepStr: '20', artifactNumToKeepStr: '10')),
        disableConcurrentBuilds(),
        parameters([
            string(name: 'cucumber_gitrepo', defaultValue: 'https://github.com/SUSE/spacewalk.git', description: 'Testsuite Git Repository'),
            string(name: 'cucumber_ref', defaultValue: 'Manager-4.3', description: 'Branch prepared for the MU tested'),
            string(name: 'targeted_project', defaultValue: 'manager-4.3-qe-build-validation-NUE', description: 'Path to the tf file to be used'),
            string(name: 'sumaform_gitrepo', defaultValue: 'https://github.com/uyuni-project/sumaform.git', description: 'Sumaform Git Repository'),
            string(name: 'sumaform_ref', defaultValue: 'master', description: 'Sumaform Git reference (branch, tag...)'),
            choice(name: 'sumaform_backend', choices: ['libvirt'], description: 'Sumaform backend to be used (see https://github.com/uyuni-project/sumaform#backend-choice)'),
            choice(name: 'terraform_bin', choices: ['/usr/bin/terraform'], description: 'Terraform binary path'),
            choice(name: 'terraform_bin_plugins', choices: ['/usr/bin'], description: 'Terraform plugins path'),
            string(name: 'terraform_parallelism', defaultValue: '', description: 'Advanced: Define the number of parallel resource operations for terraform'),
            // Temporary: should move to uyuni-project
            string(name: 'terracumber_gitrepo', defaultValue: 'https://github.com/uyuni-project/terracumber.git', description: 'Terracumber Git Repository'),
            string(name: 'terracumber_ref', defaultValue: 'master', description: 'Terracumber Git ref (branch, tag...)'),
            string(name: 'container_repository', defaultValue: 'registry.suse.de/suse/sle-15-sp6/update/products/manager50/update/containerfile', description: 'Proxy and server container registry'),
            string(name: 'manager_hostname', defaultValue: 'suma-bv-43-srv.mgr.suse.de', description: 'Manager hostname'),
            extendedChoice(name: 'minions_to_run',  multiSelectDelimiter: ', ', quoteValue: false, saveJSONParameterToFile: false, type: 'PT_CHECKBOX', visibleItemCount: 15,
                    value: minionList,
                    defaultValue: minionList,
                    description: 'Node list to run during BV'),
            text(name: 'mi_ids', defaultValue: '', description: 'MI Identifiers separated by comma or whitespaces (Option A)'),
            text(name: 'custom_repositories', defaultValue: '{}', description: 'MU Repositories in json format (Option B)')
            ])
    ])

    stage('Checkout pipeline') {
        checkout scm
    }
    def pipeline = load "jenkins_pipelines/environments/common/pipeline-build-validation-cleanup.groovy"
    pipeline.run(params)
}
