#!/usr/bin/env groovy

node('sumaform-cucumber') {
        properties([
                buildDiscarder(logRotator(numToKeepStr: '10', artifactNumToKeepStr: '1')),
                pipelineTriggers([cron('H 3 * * *')]),
                disableConcurrentBuilds(),
                parameters([
                        string(name: 'tf_file', defaultValue: 'susemanager-ci/terracumber_config/tf_files/MLM-Head-refenv-mcp-server.tf', description: 'Path to the tf file to be used'),
                        string(name: 'sumaform_gitrepo', defaultValue: 'https://github.com/uyuni-project/sumaform.git', description: 'Sumaform Git Repository'),
                        string(name: 'sumaform_ref', defaultValue: 'master', description: 'Sumaform Git reference (branch, tag...)'),
                        choice(name: 'sumaform_backend', choices: ['libvirt', 'aws'], description: 'Sumaform backend to be used (see https://github.com/uyuni-project/sumaform#backend-choice)'),
                        choice(name: 'bin_path', choices: ['/usr/bin/tofu', '/usr/bin/terraform'], description: 'Binary path'),
                        choice(name: 'bin_plugins_path', choices: ['/usr/bin'], description: 'Plugins path'),
                        string(name: 'terracumber_gitrepo', defaultValue: 'https://github.com/uyuni-project/terracumber.git', description: 'Terracumber Git Repository'),
                        string(name: 'terracumber_ref', defaultValue: 'master', description: 'Terracumber Git ref (branch, tag...)'),
                        booleanParam(name: 'terraform_init', defaultValue: true, description: 'Call terraform init (needed if modules are added or changes)'),
                        booleanParam(name: 'terraform_taint', defaultValue: true, description: 'Call terraform taint (so the resources, except volumes, are recreated)'),
                        booleanParam(name: 'use_previous_terraform_state', defaultValue: true, description: 'Use previous Terraform state')
                ])
        ])

        timestamps {
            // Init path env variables
            env.resultdir = "${WORKSPACE}/results"
            env.resultdirbuild = "${resultdir}/${BUILD_NUMBER}"

            // The junit plugin doesn't affect full paths
            junit_resultdir = "results/${BUILD_NUMBER}/results_junit"
            env.common_params = "--outputdir ${resultdir} --tf ${params.tf_file} --gitfolder ${resultdir}/sumaform --terraform-bin ${params.bin_path}"
            if (params.deploy_parallelism) {
                env.common_params = "${env.common_params} --parallelism ${params.deploy_parallelism}"
            }

            // Start pipeline
            deployed = false
            try {
                stage('Clone terracumber, susemanager-ci and sumaform') {
                    git url: params.terracumber_gitrepo, branch: params.terracumber_ref
                    dir("susemanager-ci") {
                        checkout scm
                    }

                    // Create a directory for  to place the directory with the build results (if it does not exist)
                    sh "mkdir -p ${resultdir}"

                    // Clone sumaform
                    sh "set +x; source /home/jenkins/.credentials set -x; ./terracumber-cli ${common_params} --gitrepo ${params.sumaform_gitrepo} --gitref ${params.sumaform_ref} --runstep gitsync"

                    // Restore Terraform states from artifacts
                    if (params.use_previous_terraform_state) {
                        copyArtifacts projectName: currentBuild.projectName, selector: specific("${currentBuild.previousBuild.number}")
                    }
                }

                stage('Deploy') {
                    // Provision the environment
                    if (params.terraform_init) {
                        env.TERRAFORM_INIT = '--init'
                    } else {
                        env.TERRAFORM_INIT = ''
                    }
                    env.TERRAFORM_TAINT = ''
                    if (params.terraform_taint) {
                        switch(params.sumaform_backend) {
                            case "libvirt":
                                env.TERRAFORM_TAINT = " --taint '.*(domain|main_disk|data_disk|database_disk|standalone_provisioning).*'";
                                break;
                            case "aws":
                                env.TERRAFORM_TAINT = " --taint '.*(host).*'";
                                break;
                            default:
                                println("ERROR: Unknown backend ${params.sumaform_backend}");
                                sh "exit 1";
                                break;
                        }
                    }
                    sh "set +x; source /home/jenkins/.credentials set -x; export TF_VAR_CUCUMBER_GITREPO=${params.cucumber_gitrepo}; export TF_VAR_CUCUMBER_BRANCH=${params.cucumber_ref}; export TERRAFORM=${params.bin_path}; export TERRAFORM_PLUGINS=${params.bin_plugins_path}; ./terracumber-cli ${common_params} --logfile ${resultdirbuild}/sumaform.log ${env.TERRAFORM_INIT} ${env.TERRAFORM_TAINT} --sumaform-backend ${params.sumaform_backend} --runstep provision | sed -E 's/([^.]+)module\\.([^.]+)\\.module\\.([^.]+)(\\.module\\.[^.]+)?(\\[[0-9]+\\])?(\\.module\\.[^.]+)?(\\.[^.]+)?(.*)/\\1\\2.\\3\\8/'"
                    deployed = true
                }

                stage('Run MCP Server') {
                    sh "ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null root@mlm-ref-head-mcp-server.mgr.suse.de 'zypper install -y docker; systemctl start docker; systemctl enable docker'"
                    sh "ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null root@mlm-ref-head-mcp-server.mgr.suse.de 'docker run -e UYUNI_SERVER=mlm-ref-head-server.mgr.suse.de -e UYUNI_MCP_TRANSPORT=http -e UYUNI_MCP_HOST=0.0.0.0 -e UYUNI_MCP_PORT=8080 ghcr.io/uyuni-project/mcp-server-uyuni:latest -e UYUNI_USER=admin -e UYUNI_PASS=admin -p 8080:8080 ghcr.io/uyuni-project/mcp-server-uyuni:latest'"
                }
            }

            finally {
                stage('Save TF state') {
                    archiveArtifacts artifacts: "results/sumaform/terraform.tfstate, results/sumaform/.terraform/**/*"
                    // Clean up old results
                    sh "./clean-old-results -r ${resultdir}"
                    sh "exit ${error}"
                }
            }
        }
    }
