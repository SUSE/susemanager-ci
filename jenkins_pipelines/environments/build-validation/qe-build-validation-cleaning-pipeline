#!/usr/bin/env groovy

node {
    // Default node
    String nodeName = 'sumaform-cucumber'

    // Check the value of targeted_project and adjust the nodeName accordingly
    if (params.targeted_project.contains('BACKUP')) {
        nodeName = 'sumaform-cucumber-slc1'  // Use this for BACKUP projects
    } else if (params.targeted_project.contains('NUE')) {
        nodeName = 'sumaform-cucumber'  // Use this for NUE projects
    }

    // Run on the selected node
    node(nodeName) {
        properties([
                buildDiscarder(logRotator(numToKeepStr: '5', artifactNumToKeepStr: '3')),
                disableConcurrentBuilds(),
                parameters([
                        choice(name: 'targeted_project', choices: [
                                'default',
                                'manager-4.3-qe-build-validation',
                                'manager-5.0-micro-qe-build-validation',
                                'manager-5.0-sles-qe-build-validation',
                                'manager-5.1-micro-qe-build-validation',
                                'manager-5.1-sles-qe-build-validation',
                                'manager-qe-continuous-build-validation',
                                'manager-4.3-qe-build-validation-BACKUP',
                                'manager-5.0-qe-build-validation-BACKUP',
                                'manager-5.1-qe-build-validation-BACKUP'
                        ], description: 'Path to the tf file to be used'),
                        string(name: 'terracumber_gitrepo', defaultValue: 'https://github.com/uyuni-project/terracumber.git', description: 'Terracumber Git Repository'),
                        string(name: 'terracumber_ref', defaultValue: 'master', description: 'Terracumber Git ref (branch, tag...)'),
                        string(name: 'proxy_container_repository', defaultValue: 'registry.suse.de/suse/sle-15-sp6/update/products/manager50/update/containerfile', description: 'Proxy container registry'),
                        booleanParam(name: 'delete_all_resources', defaultValue: false, description: 'Proxy, Monitoring and Retail will be redeployed')
                ])
        ])

        stage('Checkout pipeline') {
            checkout scm
        }

        def mutableParams = [:] + params
        mutableParams.sumaform_backend = 'libvirt'
        mutableParams.bin_path = '/usr/bin/tofu'
        mutableParams.bin_plugins_path = '/usr/bin'
        // Load and run the pipeline
        def pipeline = load "jenkins_pipelines/environments/common/pipeline-build-validation-cleanup.groovy"
        pipeline.run(mutableParams)
    }
}
