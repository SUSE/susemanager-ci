#!/usr/bin/env groovy

// Configure the build properties
properties([
    buildDiscarder(logRotator(numToKeepStr: '500', daysToKeepStr: '4')),
    disableConcurrentBuilds(),
])

pipeline {

  // env variables
  environment { 
    // specific psql conf
    repository = "uyuni-project/uyuni"
    context = "schema_migration_test_pgsql" 
    description = "schema migration test" 
    filter = "schema/spacewalk"
    git_fs = "${env.WORKSPACE}"      
    test = "susemanager-utils/testing/automation/schema-migration-test-pgsql.sh" \
    // trigger tests
    check = "gitarro.ruby2.1  -r ${repository}" + 
            " -c ${context} -d ${description} " +
            " -f ${filter} " +
            " -t ${test} " +
            " -g ${git_fs} " +
            "--check --changed_since 3600" 
    // postgresql
    runtest_pg = "gitarro.ruby2.1  -r ${repository}" + 
                 " -c ${context} -d ${description} " +
                 " -f ${filter} " +
                 " -g ${git_fs} " +
                 " -u \"${env.BUILD_URL}\"" +
                 " -t ${test} " 
  }

  // run only on specific hosts
  agent { label 'suse-manager-unit-tests' }
  // trigger
  triggers { cron('H/5 * * * *') }
  stages {
    stage('Check Pull Request') {
      steps {
        echo 'Check if a PR need a test'
        sh "${check} | grep \"TESTREQUIRED=true\" "
        }
      }
     stage('Run schema tests postgresql') {
          steps {
            echo 'Run tests'
            sh "$runtest_pg"
            }
     }
  
  }
  post { 
        always { 
            cleanWs()
        }
    }
}
